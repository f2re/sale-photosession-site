# Installation with telegram-bots-platform

This guide explains how to deploy the PhotoSession AI Website using the [telegram-bots-platform](https://github.com/f2re/telegram-bots-platform).

> **ðŸ’¡ Having issues?** Check the [Troubleshooting Guide](./TROUBLESHOOTING.md) for common problems and solutions.

## Prerequisites

1. **telegram-bots-platform** installed and configured on Debian 12 server
2. **Domain name** pointing to your server
3. **Telegram Bot Token** from [@BotFather](https://t.me/BotFather)
4. **OpenRouter API Key** for AI image generation
5. **YooKassa credentials** for payments

## Architecture Overview

When deployed with the platform:

- **Single Docker container** with multi-stage build:
  - Stage 1: Node.js builds frontend static files
  - Stage 2: Python backend + static files copied from stage 1
- **Backend API** runs on auto-assigned port (default: 8000, localhost only)
- **Frontend static files** mounted as volume and served directly by nginx
- **Database** is automatically created and configured by the platform
- **Nginx** reverse proxy serves static files and proxies API requests
- **Network** uses shared `bots_shared_network` for service isolation

## Installation Steps

### 1. Add Site to Platform

```bash
cd /opt/telegram-bots-platform
sudo ./add-bot.sh
```

You will be prompted for:

- **Bot name**: `photosession-site` (or your preferred name)
- **GitHub repository**: `https://github.com/f2re/sale-photosession-site`
- **Telegram bot token**: Your bot token from BotFather
- **Domain**: Your domain (e.g., `photos.yourdomain.com`)
- **Backend port**: Press Enter for auto-assignment or specify (e.g., `8000`)

The platform will:
- âœ… Clone the repository
- âœ… Create PostgreSQL database (`photosession_site_db`)
- âœ… Generate database credentials
- âœ… Configure Nginx reverse proxy
- âœ… Obtain SSL certificate (Let's Encrypt)
- âœ… Create `.env` file with auto-generated values
- âœ… Build and start Docker containers

### 2. Configure Environment Variables

After installation, edit the `.env` file:

```bash
sudo nano /opt/telegram-bots-platform/bots/photosession-site/.env
```

Update these required variables:

```env
# Telegram Bot (already configured by platform)
BOT_TOKEN=<auto-filled>
BOT_USERNAME=your_bot_username
TELEGRAM_BOT_ID=<your_bot_id>
ADMIN_IDS=123456789,987654321

# Database (auto-configured by platform)
DATABASE_URL=<auto-generated>
POSTGRES_HOST=172.25.0.1
POSTGRES_PORT=5432
POSTGRES_DB=<auto-generated>
POSTGRES_USER=<auto-generated>
POSTGRES_PASSWORD=<auto-generated>

# API URLs (use your domain)
DOMAIN=photos.yourdomain.com
API_URL=https://photos.yourdomain.com
SITE_URL=https://photos.yourdomain.com

# Security
SECRET_KEY=<generate-random-key>
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# OpenRouter API (REQUIRED for image generation)
OPENROUTER_API_KEY=sk-or-v1-xxxxx
PROMPT_MODEL=anthropic/claude-3.5-sonnet
IMAGE_MODEL=google/gemini-2.0-flash-001

# YooKassa Payments (REQUIRED for purchases)
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
YOOKASSA_RETURN_URL=https://photos.yourdomain.com/payment/success

# Optional: Yandex Metrika
YANDEX_METRIKA_COUNTER_ID=
YANDEX_METRIKA_TOKEN=
```

### 3. Fix docker-compose.yml (Important!)

The platform may auto-generate a docker-compose.yml with incorrect paths. Copy our version:

```bash
cd /opt/telegram-bots-platform/bots/photosession-site
cp app/docker-compose.yml ./docker-compose.yml
```

### 4. Initialize Database

Initialize database tables (first time only):

```bash
cd /opt/telegram-bots-platform/bots/photosession-site
sudo docker-compose exec bot python init_db.py
```

### 5. Build Container (Builds Frontend Automatically)

The multi-stage Dockerfile builds the frontend automatically:

```bash
cd /opt/telegram-bots-platform/bots/photosession-site
sudo docker-compose build --no-cache
```

This will:
- Build React frontend using Node.js 22
- Copy static files to backend container
- Install Python dependencies
- Create single optimized container

### 6. Setup Nginx (Critical!)

Configure nginx to serve static files and proxy API:

```bash
cd /opt/telegram-bots-platform/bots/photosession-site/app
sudo bash setup-nginx.sh
# Enter your domain when prompted
```

This will:
- Create nginx configuration for your domain
- Serve static files directly from `/static/` directory
- Route `/api` to backend (FastAPI)
- Setup WebSocket proxying
- Enable proper caching for assets
- Enable the site and reload nginx

**Manual alternative**: See [NGINX_CONFIG.md](./NGINX_CONFIG.md) for manual setup.

### 7. Start Services

After updating `.env` and nginx:

```bash
cd /opt/telegram-bots-platform/bots/photosession-site
sudo docker-compose up -d
```

**If you get build errors**, see the [Troubleshooting Guide](./TROUBLESHOOTING.md#build-errors).

### 8. Verify Installation

Check service status:

```bash
# View running containers
sudo docker ps | grep photosession

# Check container logs (backend + build output)
sudo docker logs -f photosession-site_bot

# Check static files were mounted
ls -la /opt/telegram-bots-platform/bots/photosession-site/static/

# Check Nginx configuration
sudo nginx -t

# Test frontend (should return HTML)
curl https://photos.yourdomain.com

# Test API endpoint
curl https://photos.yourdomain.com/api
curl https://photos.yourdomain.com/docs
```

Your site should now be accessible at `https://photos.yourdomain.com`

## Database Sharing with Telegram Bot

To share the database with a Telegram bot (e.g., [sale-photosession-bot](https://github.com/f2re/sale-photosession-bot)), the website and bot must use the **same PostgreSQL database**.

ðŸ“– **[See detailed database sharing guide â†’](./DATABASE_SHARING.md)**

### Quick Setup

1. **Install this website first** (creates the database)
2. **Get database credentials**:
   ```bash
   sudo cat /root/.platform/photosession-site_db_credentials
   ```
3. **Install bot with same credentials**:
   ```env
   DATABASE_URL=postgresql+asyncpg://photosession_site_user:password@172.25.0.1:5432/photosession_site_db
   ```

Both services will share:
- âœ… User accounts and balances
- âœ… Photoshoot history
- âœ… Payment records
- âœ… Generated images
- âœ… Analytics data

## Updating the Site

To update to the latest version:

```bash
cd /opt/telegram-bots-platform/bots/photosession-site/app
sudo git pull origin main
cd ..
sudo docker-compose down
sudo docker-compose up -d --build
```

## Monitoring

View logs:

```bash
# Container logs (includes frontend build + backend runtime)
sudo docker logs -f photosession-site_bot

# Nginx access logs
sudo tail -f /var/log/nginx/sale-photosession-site-access.log

# Nginx error logs
sudo tail -f /var/log/nginx/sale-photosession-site-error.log
```

## Troubleshooting

### Database Connection Issues

Check database credentials:

```bash
sudo cat /root/.platform/photosession-site_db_credentials
```

Test database connection:

```bash
sudo -u postgres psql -d photosession_site_db -c "\dt"
```

### Port Conflicts

If backend port is already in use, modify `.env`:

```env
BACKEND_PORT=8001
```

Then restart:

```bash
sudo docker-compose down
sudo docker-compose up -d
```

### SSL Certificate Issues

Renew SSL certificate:

```bash
sudo certbot renew
sudo systemctl reload nginx
```

### Frontend Build Errors

If frontend build fails, check build logs:

```bash
sudo docker-compose logs bot | grep -A 20 "npm run build"
```

Rebuild container with no cache:

```bash
sudo docker-compose build --no-cache bot
```

## Platform Commands

The platform provides convenient aliases:

```bash
# Check all bots status
bot-status

# View specific bot
bot-status photosession-site

# Restart bot
cd /opt/telegram-bots-platform/bots/photosession-site
sudo docker-compose restart
```

## Security Notes

1. **Firewall**: Platform configures UFW automatically
2. **SSL**: Auto-renewed by Let's Encrypt
3. **Database**: Isolated per bot with strong passwords
4. **Secrets**: Never commit `.env` to Git
5. **CORS**: Configure `CORS_ORIGINS` to allow only your domain

## Support

- **Platform Issues**: https://github.com/f2re/telegram-bots-platform/issues
- **Site Issues**: https://github.com/f2re/sale-photosession-site/issues

## Next Steps

After successful installation:

1. âœ… Configure your Telegram bot with [@BotFather](https://t.me/BotFather)
2. âœ… Set up webhook URL in your bot code
3. âœ… Configure YooKassa payment integration
4. âœ… Set up Yandex Metrika (optional)
5. âœ… Test authentication flow
6. âœ… Test image generation
7. âœ… Test payment process
